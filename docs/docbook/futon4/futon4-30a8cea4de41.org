#+TITLE: Docbook TOC system
:PROPERTIES:
:DOC_ID: futon4-30a8cea4de41
:ENTRY_ID: futon4-30a8cea4de41::org
:VERSION: org
:OUTLINE_PATH: Docbook TOC system
:PATH_STRING: Docbook TOC system
:REPLACES:
:END:

* Overview
The TOC system stores the docbook outline order as a JSON list of headings.
This keeps ordering stable across sessions and lets the browser reapply a
preferred order even when entries are fetched from remote storage.

* What the TOC tracks
Each toc.json entry includes doc id, title, outline path, path string, and
level. The browser uses these fields to render the contents view and to keep
section ordering consistent.

The filesystem toc.json is a snapshot used for offline browsing; the canonical
outline lives in XTDB headings and is served by `/docs/:book/toc`.

* Ordering and top-level preferences
`arxana-docbook--order-headings` applies an explicit order list on top of the
raw headings. For top-level sections, the browser can apply
`arxana-browser-docbook-top-order` so key sections stay in a preferred order.

* Dirty state and sync
When the contents view is reordered, the local order is tracked separately from
the last synced order. The header shows a dirty indicator until
`arxana-docbook--toc-write-order` (or the remote order endpoint) has been
updated.

To push ordering to XTDB, use `M-x arxana-browser-docbook-sync-order` which
posts to `/docs/:book/contents/order`. Outline changes require updating the
docbook entries themselves, not just toc.json.

* Safety guarantees

- Filesystem edits are only pushed when you explicitly sync (`C-c C-s`).
- Checkout avoids clobbering newer local stubs: it skips remote entries when
  local mtime is newer (`arxana-docbook--entry-local-newer-p`).
- TOC order changes are separate from content and require an explicit sync to
  `/docs/:book/contents/order`.

* Export helpers
`dev/docbook-toc-export.el` regenerates toc.json from an Org index file. This
is the batch-friendly way to rebuild the TOC when headings change on disk.

* Ingest pipeline (XTDB)

- Docbook stubs are edited locally and synced with `C-c C-s`, posting to
  `/docs/:book/entry`.
- Bulk entry ingestion can use the Futon1 docbook ingest script with
  `dev/logs/books/<book>/raw` (generated by backfill/summarize scripts).
- Legacy `spine2.org` ingestion is deprecated and should not be relied on for
  current manuals.
- Ingest is gated by Charon envelopes in Futon1; invariant failures can block
  docbook and pattern ingest. Use `/api/alpha/meta/model/docbook/verify` to
  inspect failures and `/api/alpha/docs/:book/heading/:doc-id` to inspect
  the offending entry.
