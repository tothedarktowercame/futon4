#+TITLE: Link-following & history
:PROPERTIES::SYNCED_AT: 2026-01-10T13:12:19Z
:SYNCED_AT: 2026-01-10T13:57:11Z

:DOC_ID: futon4-bced1ef693fb
:ENTRY_ID: futon4-bced1ef693fb::org
:VERSION: org
:OUTLINE_PATH: Browsing & relations / Link-following & history
:PATH_STRING: Browsing & relations / Link-following & history
:REPLACES: 
:END:

* Context
Arxana links focus on preserving intent rather than storing every computed
edge. /Strategies/ describe how to find links; anchors and scholia capture the
human signal around them.  When strategies are persisted, links can be
recomputed as documents evolve without losing the provenance of the
annotations that motivated them!!

* Link tiers

- Tier 0 (Ephemeral): computed links only, no persistence.
- Tier 1 (Strategy): persist finder rules; links can be recomputed.
- Tier 2 (Anchored): persist anchored regions for immutable or historic text.

* Core workflows

** Authoring workflow (explicit + persisted)

Use this when you want durable, inspectable links.

1. Decide the intent:
   - Scholium = a human annotation anchored to a region.
   - Surface form = "this phrase refers to that concept".
   - Voiced link = "this code symbol links to this doc paragraph".
2. Capture it with a concrete command:
   - Scholium (interactive):
     - Select a region, then `M-x arxana-links-demo-create-scholium`.
   - Surface form (interactive):
     - Select a phrase, then `M-x arxana-links-capture-surface-form`.
     - Enter concept id (e.g. `concept:arxana-compat-shim`).
     - Provide a concept label and optional gloss for the inspectable record.
     - Edit later with `M-x arxana-links-edit-surface-form`.
     - Or use `M-x arxana-links-edit-surface-form-at-point` in the examples block.
   - Voiced link (interactive):
     - `M-x arxana-links-demo-promote-link`.
   - Voiced link (non-interactive, recommended for scripts):
     - `M-:` then:
       #+begin_src elisp
       (arxana-links-promote-voiced-link
        :source-file "/home/joe/code/futon4/dev/arxana-compat.el"
        :source-symbol "arxana-compat--get-article"
        :target-docbook "futon4"
        :target-doc-id "futon4-4ee0279e2ef1"
        :render? t)
       #+end_src
3. Persist and verify:
   - `M-x arxana-links-status` is global (not tied to the current file). It
     lists persisted strategies and demo helpers for the active Futon profile.
   - For surface forms:
     - `M-:` then `(arxana-links-surface-forms-for-concept "concept:arxana-compat-shim")`.
   - For voiced links:
     - `M-:` then `(arxana-links-load-voiced-links)`.
4. Confirm in the UI:
   - Docbook entry view shows `* Voiced links` (open with `docbook://...`).
   - Code browser shows the corresponding docs and highlights as you move point.

** Data model recap

- Scholium: `arxana/scholium`
  - Target doc, anchor (content hash + context), content.
- Surface form: `arxana/surface-form`
  - `:concept-id`, `:surface`, `:context`, `:source`.
- Voiced link: `arxana/voiced-link`
  - `:source` (code symbol) and `:target` (doc paragraph).

** Examples (inspectable)

The following block renders live UI elements in the docbook view.

#+BEGIN_ARXANA_LINK_EXAMPLES
:concept-id: concept:arxana-compat-shim
:surface-form-id: surface:030fc81c76b6c366e4745f9e0f293768
:voiced-link-id: link:0958676ef4a41e3f68311ee81817b6b1
#+END_ARXANA_LINK_EXAMPLES

** Check status

#+begin_src elisp
M-x arxana-links-status
#+end_src

** Create or load a strategy

#+begin_src elisp
M-x arxana-links-demo-create-strategy
M-x arxana-browser-code-strategy-status
#+end_src

The demo uses the futon4 repo and a definition-based finder. It is safe to
run multiple times because the strategy id is deterministic.
Surface form matching is enabled by the `:surface-form-hybrid` finder type.

** Create a resilient scholium

1. Select a region in a buffer.
2. Run M-x arxana-links-demo-create-scholium.
3. Enter the annotation text.

Anchors use content hashes and surrounding context so they survive minor
edits.

** Capture a surface form

1. Select a phrase.
2. Run M-x arxana-links-capture-surface-form.
3. Provide the concept id.

Surface forms inform finders and auto-linking later on.

** Verify anchors

#+begin_src elisp
M-x arxana-links-demo-verify-anchor
#+end_src

This runs the three-step re-finding algorithm (offset check, context search,
fuzzy context).

** Embedding neighbors for patterns

#+begin_src elisp
M-x arxana-browser-patterns-embedding-status
M-x arxana-browser-patterns-show-neighbors
#+end_src

Embedding neighbors require a cached embedding space persisted as an
embedding cache entity.

* Persistence entities

- Strategy: arxana/link-strategy
- Voiced Link: arxana/voiced-link
- Surface Form: arxana/surface-form
- Scholium: arxana/scholium
- Embedding Cache: arxana/embedding-cache

Use arxana-links-make-* + arxana-links-persist-* to create and save these
records. Use the arxana-links-load-* helpers to retrieve them. Payloads are
stored in Futon entities with the full record serialized into the source
field so they round-trip through the existing API.

* Testing

** Unit tests (Emacs only)

#+begin_src sh
bash dev/run-tests.sh
#+end_src

** Integration tests (real Futon server)

The links test suite includes integration tests tagged :futon that run only
when a Futon server responds to /types.

#+begin_src sh
bash dev/run-tests.sh
#+end_src

Set the base URL with either futon4-base-url or FUTON4_BASE_URL if the
server is not on http://localhost:8080.

When the server is reachable, the tests exercise persistence for strategies,
voiced links, surface forms, scholia, embedding caches, and demo strategy
creation.
