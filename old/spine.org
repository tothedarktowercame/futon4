#+TITLE: Arxana spine (legacy, superseded by spine2.org)
#+NOTE: This spine is outdated. The current literate source is spine2.org.
#+OPTIONS: num:t toc:t
#+LATEX_HEADER_EXTRA: \usepackage{fontspec}
#+LATEX_HEADER_EXTRA: \usepackage[margin=2cm]{geometry}
#+LATEX_HEADER_EXTRA: \setmainfont{NewCM10-Regular}[Path=/usr/local/texlive/2025/texmf-dist/fonts/opentype/public/newcomputermodern/,Extension=.otf]
#+LATEX_HEADER_EXTRA: \newcommand{\kw}[1]{{\tt #1}}
#+LATEX_HEADER_EXTRA: \usepackage{tocloft}
#+LATEX_HEADER_EXTRA: \setlength{\cftsecnumwidth}{3em}      % for \section in toc
#+LATEX_HEADER_EXTRA: \setlength{\cftsubsecnumwidth}{4em}   % for \subsection
#+LATEX_HEADER_EXTRA: \setlength{\cftsubsubsecnumwidth}{5em}% etc., if needed


#+BEGIN_ABSTRACT
This spine collects the Arxana material into fourteen Parts, grouping related
modules so the whole is easier to navigate. The grouping is non-destructive:
filenames and internal structure are unchanged and can be further refined.
#+END_ABSTRACT

#+BEGIN_SRC elisp
    ;; Quickstart
(require 'org)
(require 'ob-tangle)
(require 'cl-lib)

(add-to-list 'org-src-lang-modes '("elisp" . emacs-lisp))
(add-to-list 'org-babel-load-languages '(emacs-lisp . t))
(org-babel-do-load-languages 'org-babel-load-languages org-babel-load-languages)

;; Treat 'elisp' blocks as Emacs Lisp when tangling.
(add-to-list 'org-babel-tangle-lang-exts '("elisp" . "el"))

;; Default: tangle elisp blocks unless :tangle no
(setq org-babel-default-header-args:elisp
      (org-babel-merge-params
       org-babel-default-header-args:elisp
       '((:tangle . "yes"))))

(defun arxana-spine-files (spine-file)
  "Return the list of files included by SPINE-FILE via #+INCLUDE."
  (with-temp-buffer
    (insert-file-contents spine-file)
    (let (files)
      (goto-char (point-min))
      (while (re-search-forward "^#\\+INCLUDE: \"\\([^\"]+\\)\"" nil t)
        (push (expand-file-name (match-string 1)
                                (file-name-directory spine-file))
              files))
      (nreverse files))))

(defun arxana-tangle-spine-concat (spine-file)
  "Tangle Org files listed in SPINE-FILE, concat their tangled .el into
arxana-tangled.el (in order), then load it.

Respects existing :tangle / :tangle no semantics.
Only deletes .el files that were created by this function."
  (interactive "fSpine file: ")
  (let* ((spine-file (expand-file-name spine-file))
         (base-dir  (file-name-directory spine-file))
         (org-files (arxana-spine-files spine-file))
         ;; Snapshot existing .el files so we know what is new later.
         (before-el (directory-files-recursively base-dir "\\.el$"))
         (tangled-files '()))

    ;; 1. Tangle each Org file, record resulting .el files.
    (dolist (org-file org-files)
      (dolist (f (org-babel-tangle-file org-file))
        (let* ((abs (if (file-name-absolute-p f)
                        f
                      (expand-file-name f (file-name-directory org-file)))))
          (push abs tangled-files))))

    ;; Preserve order of first occurrence.
    (setq tangled-files
          (cl-remove-duplicates (nreverse tangled-files)
                                :test #'string=))

    ;; 2. Build arxana-tangled.el from all tangled files.
    (let ((out (expand-file-name "arxana-tangled.el" base-dir)))
      (with-temp-file out
        (insert ";; Autogenerated from Arxana spine\n\n")
        (dolist (f tangled-files)
          (when (file-exists-p f)
            (insert ";; from " (file-relative-name f base-dir) "\n")
            ;; IMPORTANT: read from the file's own temp buffer,
            ;; not from the output buffer.
            (insert
             (with-temp-buffer
               (insert-file-contents f)
               (buffer-substring-no-properties (point-min) (point-max))))
            (insert "\n\n"))))

      ;; 3. Delete only .el files that are new (created by this run),
      ;; never the combined arxana-tangled.el itself.
      (let* ((after-el (directory-files-recursively base-dir "\\.el$"))
             (new-el (cl-set-difference after-el before-el :test #'string=)))
        (dolist (f new-el)
          (unless (string=
                   (file-truename f)
                   (file-truename out))
            (delete-file f))))

      ;; 4. Load the unified file.
      (load-file out))))

#+END_SRC

#+TOC: headlines 1

* Part I — Reintroduction and Preface
#+INCLUDE: "0-Reintroduction.org"
#+INCLUDE: "0-Preface.org"
#+INCLUDE: "1-Prelude.org"

* Part II — System Introduction
#+INCLUDE: "2-Introduction.org"
#+INCLUDE: "2.1-Overview_of_the_system.org"
#+INCLUDE: "2.2-Design_issues.org"
#+INCLUDE: "2.3-Elisp_requirements.org"
#+INCLUDE: "2.4-Lisp_preliminaries.org"

* Part III — Scholia-Based Documents
#+INCLUDE: "3-Scholia_based_documents.org"
#+INCLUDE: "3.1-The_digital_library.org"
#+INCLUDE: "3.2-Creating_scholia.org"
#+INCLUDE: "3.3-Metadata.org"
#+INCLUDE: "3.4-Consistency_conditions.org"
#+INCLUDE: "3.5-Subcollections.org"
#+INCLUDE: "3.6-Data_access_and_conversion.org"
#+INCLUDE: "3.7-Further_notes_on_scholia_based_documents.org"

* Part IV — HONEY Storage Backend
This backend is included here for reference, but its features should
be replaced by the new Clojure backend.

#+INCLUDE: "3A-HONEY_backend.org"
#+INCLUDE: "3A.1-Preliminaries.org"
#+INCLUDE: "3A.2-Core_definitions.org"
#+INCLUDE: "3A.3-Individual_Operations.org"
#+INCLUDE: "3A.4-Bulk_Operations.org"
#+INCLUDE: "3A.5-Query.org"
#+INCLUDE: "3A.6-Iteration.org"
#+INCLUDE: "3A.7-Scholium_programming.org"
#+INCLUDE: "3A.8-Initialization.org"

* Part V — SQL Storage Backend
This is omitted in the current build, though it could be reintroduced
if that was useful.

#+INCLUDE: "3B-SQL_backend.org"
#+INCLUDE: "3B.1-SQL_tables.org"
#+INCLUDE: "3B.2-Common_Lisp_side.org"
#+INCLUDE: "3B.2.1-Preliminaries.org"
#+INCLUDE: "3B.2.1.1-System_definition.org"
#+INCLUDE: "3B.2.1.2-Package_definition.org"
#+INCLUDE: "3B.2.1.3-Utilities.org"
#+INCLUDE: "3B.2.2-Main_table_definitions.org"
#+INCLUDE: "3B.2.3-Modifying_the_database.org"
#+INCLUDE: "3B.2.4-Queries.org"
#+INCLUDE: "3B.2.4.1-Sphinx_setup.org"

* Part VI — Adding and Interacting with Articles
#+INCLUDE: "4A-HONEY_middle_end.org"
#+INCLUDE: "4A.1-Database_interaction.org"
#+INCLUDE: "4-Adding_articles_to_the_digital_library.org"
#+INCLUDE: "4.1-Supplying_initial_bookkeeping_information.org"
#+INCLUDE: "4.2-Adding_text_from_an_existing_source.org"
#+INCLUDE: "4.3-Interactively_supplying_text.org"
#+INCLUDE: "4.4-Further_notes_on_adding_articles_to_the_digital_library.org"

* Part VII — Rendering and Browsing
#+INCLUDE: "5-Rendering_articles.org"
#+INCLUDE: "5.1-Formatting_articles_for_display.org"
#+INCLUDE: "5.2-Managing_windows_and_buffers.org"
#+INCLUDE: "5.3-Sorting_scholia_for_markup_purposes.org"
#+INCLUDE: "5.4-Marking_things_up.org"
#+INCLUDE: "5.5-Display_interface.org"
#+INCLUDE: "6-Browsing.org"
#+INCLUDE: "6.1-Scholia_browsing.org"
#+INCLUDE: "6.2-Local_browsing.org"
#+INCLUDE: "6.3-Catalog_browsing.org"
#+INCLUDE: "6.4-Temporal_browsing.org"
#+INCLUDE: "6.5-Linear_browsing.org"

* Part VIII — Editing and Maintenance
#+INCLUDE: "7-Editing_and_deleting.org"
#+INCLUDE: "7.1-Initiating_edits.org"
#+INCLUDE: "7.2-Editing_about_data.org"
#+INCLUDE: "7.3-Finding_revised_about_data_by_parsing_text_properties.org"
#+INCLUDE: "7.4-Committing_edits.org"
#+INCLUDE: "7.5-Editing_en_masse.org"
#+INCLUDE: "7.6-Deletion.org"
#+INCLUDE: "7.7-Responding_to_incoming_metadata.org"
#+INCLUDE: "7.8-Editing_labels.org"
#+INCLUDE: "7.9-Further_notes_on_editing_and_deleting.org"

* Part IX — Derivative Composition
#+INCLUDE: "8-Derivative_works.org"
#+INCLUDE: "8.1-Introduction_to_clusions.org"
#+INCLUDE: "8.2-Transclusion.org"
#+INCLUDE: "8.3-Inclusion.org"
#+INCLUDE: "8.4-Identification.org"
#+INCLUDE: "8.5-Rendering_articles_containing_derivative_portions.org"
#+INCLUDE: "8.6-Expanded_and_collapsed_views.org"
#+INCLUDE: "8.7-Quick_compilations_and_other_listing_tricks.org"
#+INCLUDE: "8.8-Further_notes_on_derivative_works.org"

* Part X — Persistence and Collaboration
#+INCLUDE: "9-Saving_and_restoring.org"
#+INCLUDE: "10-Distributed_authorship.org"
#+INCLUDE: "10.1-Bidirectional_updates.org"
#+INCLUDE: "10.2-Interoperability.org"
#+INCLUDE: "10.3-A_simple_scheme_for_multiuser_cooperation.org"

* Part XI — Bindings and Environment
#+INCLUDE: "11-Bindings_and_environment_variables.org"

* Part XII — Applications and Experiments
#+INCLUDE: "12-Experiments.org"
#+INCLUDE: "12.1-Some_extremely_simple_example_to_show_people_what_s_going_on.org"
#+INCLUDE: "12.2-Use_the_scholium_system_to_maintain_a_library_of_projects.org"
#+INCLUDE: "12.3-Use_the_scholium_system_to_do_literate_programming.org"
#+INCLUDE: "12.4-On_the_fly_scholium_creation.org"
#+INCLUDE: "12.5-Simulating_a_wiki_with_the_scholium_system.org"
#+INCLUDE: "12.6-Using_the_scholium_system_to_do_AI_stuff.org"
#+INCLUDE: "12.7-Using_the_scholium_system_for_HDM_things.org"
#+INCLUDE: "12.8-Model_a_physical_space_and_its_contents.org"
#+INCLUDE: "12.9-Make_more_physical_scholia.org"

* Part XIII — Reflections and Philosophy
#+INCLUDE: "13-Philosophy_of_the_scholium_system.org"
#+INCLUDE: "13.1-Mathematics_of_the_scholium_system.org"
#+INCLUDE: "13.2-Document_analysis_and_the_scholium_system.org"

* Part XIV — Conclusions and Appendices
#+INCLUDE: "14-Conclusions.org"
#+INCLUDE: "15-Appendix_A_simple_literate_programming_system.org"
#+INCLUDE: "16-Appendix_Overview_of_specifications.org"
#+INCLUDE: "17-Appendix_Time_and_workflow_management.org"
#+INCLUDE: "18-Appendix_Annotated_non_bibliography.org"
